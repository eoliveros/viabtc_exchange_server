---
- hosts: all
  vars:
    kafka_version: 2.2.0
    kafka: kafka_2.11-{{ kafka_version }}
  become: true
  gather_facts: False
  pre_tasks:
    # Ansible requires python2, which is not installed by default on Ubuntu Xenial
    - raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)
    # action: setup will gather facts after python2 has been installed
    - action: setup
  tasks:

    - name: install openjdk 8
      apt:
        name: ['openjdk-8-jdk', 'openjdk-8-jre', 'ca-certificates']

    - name: install zookeeper
      apt: name=zookeeperd

    - name: download kafka
      get_url:
        url: http://www-us.apache.org/dist/kafka/{{kafka_version}}/{{kafka}}.tgz
        dest: /tmp/{{kafka}}.tgz
        checksum: sha512:90a231fa2b6b2c099d0e24ecfba057c1de734c5c3f1c61d4a85df6cf52887e434d64e252ad786d7a38a3290f31d6cdebab5eac66b18e858b6e2bdc86adb8475c

    - name: create kafka directory
      file:
        path: /opt/kafka
        state: directory

    - name: extract kafka .tgz into /opt/kafka
      unarchive:
        copy: no
        src: /tmp/{{kafka}}.tgz
        dest: /opt/kafka

    - name: set kafka advertized listener
      replace:
        path: /opt/kafka/{{kafka}}/config/server.properties
        regexp: '#(advertised.listeners=).*(:9092)'
        replace: '\1PLAINTEXT://{{kafka_advertised_listener}}\2'

    - name: install kafka systemd service
      template: src=templates/kafka.j2 dest=/etc/systemd/system/kafka.service

    - name: stop kafka
      systemd: state=stopped name=kafka
      ignore_errors: yes

    - name: start kafka
      systemd: state=started enabled=yes name=kafka daemon_reload=yes
