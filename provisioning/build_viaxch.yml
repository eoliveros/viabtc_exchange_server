---

- name: install libev, libmpdec, libjansson, libssl
  apt:
    name: ['build-essential', 'libev-dev', 'libmpdec-dev', 'libjansson-dev', 'libssl-dev', 'liblz4-dev', 'libcurl3']

# install specific version of libmysqlclient-dev so we dont clash with libssl-dev
- name: install specific version of libmysqlclient-dev
  shell: apt install -y --allow-downgrades libmysqlclient20=5.7.11-0ubuntu6 libmysqlclient-dev=5.7.11-0ubuntu6

# ubuntu does not have a recent enough version of librdkafka
- name: download librdkafka
  get_url: url=https://github.com/edenhill/librdkafka/archive/v0.11.6.tar.gz dest=/tmp/v0.11.6.tar.gz checksum=sha256:9c0afb8b53779d968225edf1e79da48a162895ad557900f75e7978f65e642032

- name: create librdkafka directory
  file:
    path: /opt/librdkafka
    state: directory

- name: extract librdkafka .tar.gz into /opt/librdkafka
  unarchive:
    copy: no
    src: /tmp/v0.11.6.tar.gz
    dest: /opt/librdkafka

- name: make & install librdkafka
  shell: cd /opt/librdkafka/librdkafka-0.11.6 && ./configure && make && make install
  args:
    creates: /usr/local/lib/librdkafka.so

# make our own curl so we can reduce the amount of static lib dependencies needed
- name: download libcurl
  get_url: url=https://curl.haxx.se/download/curl-7.55.1.tar.gz dest=/tmp/curl-7.55.1.tar.gz checksum=sha256:09576ea5e66672648d83dce3af16d0cb294d4cba2b5d166ade39655c495f4a20

- name: create curl directory
  file:
    path: /opt/curl
    state: directory

- name: extract curl .tar.gz into /opt/curl
  unarchive:
    copy: no
    src: /tmp/curl-7.55.1.tar.gz
    dest: /opt/curl

- name: make & install libcurl
  shell: cd /opt/curl/curl-7.55.1 && ./configure && make && make install
  args:
    creates: /usr/local/lib/libcurl.so
    
#https://github.com/nodejs/http-parser
#- name: install http_parser
  #apt: pkg=http_parser state=present

- name: make network & utils
  make:
    chdir: "{{ item.dir }}"
    target: "{{ item.target }}"
  with_items:
    - { dir: '{{root_dir}}/depends/hiredis', target: 'install' }
    - { dir: '{{root_dir}}/network', target: 'all' }
    - { dir: '{{root_dir}}/utils', target: 'all' }

- name: make matchengine, marketprice, alertcenter, readhistory, accesshttp, accwsswshave 
  make:
    chdir: "{{ item.dir }}"
    target: "{{ item.target }}"
  with_items:
    - { dir: '{{root_dir}}/matchengine', target: 'all' }
    - { dir: '{{root_dir}}/marketprice', target: 'all' }
    - { dir: '{{root_dir}}/alertcenter', target: 'all' }
    - { dir: '{{root_dir}}/readhistory', target: 'all' }
    - { dir: '{{root_dir}}/accesshttp', target: 'all' }
    - { dir: '{{root_dir}}/accessws', target: 'all' }
